#!/bin/bash

set -e

[ -n "$1" ] && export COROSYNC_CLUSTER_CONFIG_FILE="$1"

# rpm based distros
if [ -d /etc/sysconfig ]; then
	[ -f /etc/sysconfig/cluster ] && . /etc/sysconfig/cluster
	[ -f /etc/sysconfig/cman ] && . /etc/sysconfig/cman
fi

# deb based distros
if [ -d /etc/default ]; then
	[ -f /etc/default/cluster ] && . /etc/default/cluster
	[ -f /etc/default/cman ] && . /etc/default/cman
fi

[ -z "$CONFIG_LOADER" ] && CONFIG_LOADER=xmlconfig
export COROSYNC_DEFAULT_CONFIG_IFACE=$CONFIG_LOADER:cmanpreconfig

tempfile=$(mktemp)

if [ -z "$tempfile" ]; then
	echo "Unable to create temp file"
	exit 255
fi

if ! ccs_config_dump > $tempfile; then
	rm -f $tempfile
	echo "Unable to get the configuration"
	exit 255
fi

xmllint \
	--relaxng @SHAREDIR@/cluster.rng \
	$tempfile >/dev/null
res=$?

rm -f $tempfile
exit $res
